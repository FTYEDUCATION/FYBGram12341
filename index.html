<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>YFBGram Chat - –§–ò–ù–ê–õ</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <script src="/socket.io/socket.io.js"></script>
    <style>
        /* --- 1. –û–ë–©–ò–ï –°–¢–ò–õ–ò --- */
        body { font-family: 'Roboto', sans-serif; background-color: #f0f2f5; margin: 0; display: flex; justify-content: center; align-items: center; min-height: 100vh; }
        #chat-container { display: none; width: 95vw; height: 95vh; max-width: 1200px; background: white; box-shadow: 0 8px 30px rgba(0, 0, 0, 0.1); border-radius: 12px; overflow: hidden; transition: all 0.3s ease; }
        .chat-layout { display: flex; height: 100%; }

        /* --- 2. –õ–û–ì–ò–ù –§–û–†–ú–ê --- */
        #login-form-container { padding: 40px; background: white; border-radius: 12px; box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1); text-align: center; }
        #login-form input, #login-form button { width: 100%; padding: 12px; margin-bottom: 15px; border-radius: 8px; border: 1px solid #ccc; box-sizing: border-box; }
        #login-form button { background-color: #007bff; color: white; border: none; cursor: pointer; font-weight: 500; transition: background-color 0.2s; }
        #login-form button:hover { background-color: #0056b3; }
        .error-message { color: red; font-size: 14px; }

        /* --- 3. –°–ü–ò–°–û–ö –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–ï–ô (–°–ê–ô–î–ë–ê–†) --- */
        #user-list { width: 320px; min-width: 250px; background-color: #ffffff; border-right: 1px solid #e5e7eb; overflow-y: auto; padding: 0; flex-shrink: 0; }
        .user-item { display: flex; align-items: center; padding: 12px 15px; cursor: pointer; border-bottom: 1px solid #f0f2f5; transition: background-color 0.2s; position: relative; }
        .user-item:hover { background-color: #f5f5f5; }
        .user-item.active { background-color: #e6f2ff; border-left: 4px solid #007bff; padding-left: 11px; }
        .user-avatar { width: 48px; height: 48px; border-radius: 50%; object-fit: cover; margin-right: 12px; border: 2px solid #fff; }
        #my-profile .user-avatar { border-color: #4cd964; }
        .status-dot { position: absolute; bottom: 12px; left: 50px; width: 10px; height: 10px; border-radius: 50%; background-color: gray; border: 2px solid white; }
        .status-online { background-color: #4cd964; }
        .unread-count { position: absolute; top: 50%; right: 15px; transform: translateY(-50%); background-color: #fa383e; color: white; border-radius: 12px; padding: 3px 8px; font-size: 13px; font-weight: 700; min-width: 15px; text-align: center; }

        /* --- 4. –û–ö–ù–û –ß–ê–¢–ê --- */
        #chat-window { flex-grow: 1; display: flex; flex-direction: column; }
        #chat-header { display: flex; align-items: center; padding: 10px 20px; border-bottom: 1px solid #e5e7eb; background-color: #ffffff; }
        #recipient-avatar { width: 40px; height: 40px; }
        #recipient-name { font-weight: 500; font-size: 1.1em; }
        #chat-messages { flex-grow: 1; overflow-y: auto; padding: 20px; background-color: #f0f2f5; display: flex; flex-direction: column; }
        
        /* --- 5. –ü–£–ó–´–†–ò –°–û–û–ë–©–ï–ù–ò–ô --- */
        .message-container { display: flex; margin-bottom: 10px; }
        .message-bubble { max-width: 65%; padding: 10px 15px; border-radius: 18px; word-wrap: break-word; font-size: 15px; line-height: 1.4; position: relative; }
        
        .my-message-container { justify-content: flex-end; }
        .my-message { background-color: #007bff; color: white; border-bottom-right-radius: 4px; margin-right: 0; }
        
        .their-message-container { justify-content: flex-start; }
        .their-message { background-color: #e5e7eb; color: #1c1e21; border-bottom-left-radius: 4px; }
        
        /* –ú–µ–¥–∏–∞ –≤–Ω—É—Ç—Ä–∏ —Å–æ–æ–±—â–µ–Ω–∏–π */
        .message-bubble img, .message-bubble audio, .message-bubble video { 
            max-width: 100%; 
            height: auto; 
            display: block; 
            border-radius: 8px; 
            margin: 5px 0 2px;
            /* –£–±–µ–¥–∏–º—Å—è, —á—Ç–æ –º–µ–¥–∏–∞ –Ω–µ —Ä–∞—Å—Ç—è–≥–∏–≤–∞–µ—Ç –ø—É–∑—ã—Ä—å –±–æ–ª—å—à–µ max-width */
            box-sizing: border-box; 
        }
        .message-bubble audio { min-width: 200px; }

        .message-timestamp { display: block; font-size: 10px; color: rgba(255, 255, 255, 0.7); text-align: right; margin-top: 5px; }
        .their-message .message-timestamp { color: rgba(0, 0, 0, 0.5); }
        .read-status-icon { font-size: 10px; margin-left: 5px; color: #88bbff; }
        
        /* --- 6. –û–ë–õ–ê–°–¢–¨ –í–í–û–î–ê --- */
        #message-input-area { display: flex; align-items: flex-end; padding: 10px 15px; border-top: 1px solid #e5e7eb; background-color: #ffffff; }
        #message-input { flex-grow: 1; padding: 10px 15px; border: 1px solid #ccc; border-radius: 20px; resize: none; max-height: 100px; overflow-y: auto; margin-right: 8px; }
        
        .input-button { background-color: #007bff; color: white; border: none; border-radius: 50%; width: 40px; height: 40px; margin-left: 5px; cursor: pointer; font-size: 20px; flex-shrink: 0; transition: background-color 0.2s; }
        .input-button:hover { background-color: #0056b3; }
        #voice-record-btn.recording { background-color: #fa383e; animation: pulse 1s infinite; }

        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(250, 56, 62, 0.7); } 70% { box-shadow: 0 0 0 10px rgba(250, 56, 62, 0); } 100% { box-shadow: 0 0 0 0 rgba(250, 56, 62, 0); } }

        /* --- 7. –ê–î–ê–ü–¢–ò–í–ù–û–°–¢–¨ (–ö–õ–Æ–ß–ï–í–û–ô –ë–õ–û–ö –î–õ–Ø –¢–ï–õ–ï–§–û–ù–ê) --- */
        @media (max-width: 768px) {
            #chat-container { width: 100vw; height: 100vh; max-width: none; border-radius: 0; }
            .chat-layout { position: relative; }
            #user-list { position: absolute; width: 100%; height: 100%; z-index: 10; transform: translateX(-100%); transition: transform 0.3s ease; }
            #user-list.active { transform: translateX(0); }
            #chat-window { width: 100%; }
            .message-bubble { max-width: 80%; }
            
            /* –î–æ–±–∞–≤–ª—è–µ–º –∫–Ω–æ–ø–∫—É "–ù–∞–∑–∞–¥" –¥–ª—è –º–æ–±–∏–ª—å–Ω–æ–π –≤–µ—Ä—Å–∏–∏ */
            #chat-header { justify-content: space-between; }
            .back-button { display: block; font-size: 24px; margin-right: 10px; cursor: pointer; } 
        }

        /* --- 8. –ú–û–î–ê–õ–¨–ù–û–ï –û–ö–ù–û --- */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 100; justify-content: center; align-items: center; }
        .modal-content { background: white; padding: 30px; border-radius: 12px; max-width: 400px; width: 90%; text-align: center; }
    </style>
</head>
<body>

    <div id="chat-container">
        <div class="chat-layout">
            
            <div id="user-list">
                <div id="my-profile" class="user-item" style="cursor: default; background-color: #f0f0f0;">
                    <img id="my-avatar" class="user-avatar" src="/avatars/default.jpg" alt="–ú–æ–π –∞–≤–∞—Ç–∞—Ä">
                    <span id="my-username" class="user-name"></span>
                    <button id="edit-profile-btn" class="input-button" style="width: 30px; height: 30px; font-size: 15px; margin-left: auto;">‚öôÔ∏è</button>
                </div>
                <h4 style="padding: 0 15px; color: #555;">–ö–æ–Ω—Ç–∞–∫—Ç—ã:</h4>
                <div id="users-container"></div>
            </div>

            <div id="chat-window">
                <div id="chat-header">
                    <span id="back-to-list-btn" class="back-button" style="display: none;">&#9664;</span> 
                    
                    <img id="recipient-avatar" class="user-avatar" src="/avatars/default.jpg" alt="–ê–≤–∞—Ç–∞—Ä —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∞">
                    <span id="recipient-name" class="user-name" style="margin-left: 10px;">–í—ã–±–µ—Ä–∏—Ç–µ —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∞</span>
                </div>
                
                <div id="chat-messages"></div>
                
                <div id="message-input-area">
                    <button id="file-button" class="input-button" title="–ü—Ä–∏–∫—Ä–µ–ø–∏—Ç—å —Ñ–∞–π–ª">üìé</button>
                    <input 
                        type="file" 
                        id="file-input" 
                        style="display: none;" 
                        accept="image/*, video/*, audio/*" 
                    /> 

                    <textarea id="message-input" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." rows="1"></textarea>
                    
                    <button id="voice-record-btn" class="input-button" title="–ó–∞–ø–∏—Å–∞—Ç—å –≥–æ–ª–æ—Å–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ">üéôÔ∏è</button>
                    <button id="send-button" class="input-button" title="–û—Ç–ø—Ä–∞–≤–∏—Ç—å">‚û§</button>
                </div>
            </div>
        </div>
    </div>
    
    <script>
    const socket = io();
    
    let currentUser, currentUserAvatar, currentRecipient, currentRoom;
    let allUsersAvatars = {};
    let unreadCounts = {}; 
    let isRecording = false, mediaRecorder, audioChunks = [], newAvatarBase64 = null; 

    // –≠–ª–µ–º–µ–Ω—Ç—ã DOM
    const chatMessages = document.getElementById('chat-messages');
    const messageInput = document.getElementById('message-input');
    const usersContainer = document.getElementById('users-container');
    const fileInput = document.getElementById('file-input'); 
    const voiceRecordBtn = document.getElementById('voice-record-btn');
    const userList = document.getElementById('user-list');
    const backToListBtn = document.getElementById('back-to-list-btn');

    // --- –§–£–ù–ö–¶–ò–ò –ò–ù–¢–ï–†–§–ï–ô–°–ê –ò –ú–ï–î–ò–ê (–ö–õ–Æ–ß–ï–í–´–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–Ø) ---

    function getCacheBreakUrl(url) {
        if (url) { return url + '?' + new Date().getTime(); }
        return url;
    }

    function renderMessage(msg, currentUsername) {
        // ... (–ª–æ–≥–∏–∫–∞ renderMessage –∏–∑ –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ –æ—Ç–≤–µ—Ç–∞) ...
        // –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –≤–Ω—É—Ç—Ä–∏ renderMessage –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è getCacheBreakUrl(msg.url)
        // –¥–ª—è –≤—Å–µ—Ö –º–µ–¥–∏–∞-—ç–ª–µ–º–µ–Ω—Ç–æ–≤ (img, audio, video)
        // ...
        return container;
    }

    // --- –ê–î–ê–ü–¢–ò–í–ù–û–°–¢–¨ (–ù–û–í–´–ï –§–£–ù–ö–¶–ò–ò) ---

    function showChatWindow() {
        if (window.innerWidth <= 768) {
            userList.style.transform = 'translateX(-100%)';
            backToListBtn.style.display = 'block';
        }
        scrollToBottom();
    }

    function showUserList() {
        if (window.innerWidth <= 768) {
            userList.style.transform = 'translateX(0)';
            backToListBtn.style.display = 'none';
        }
    }

    backToListBtn.addEventListener('click', showUserList);


    function joinRoom(recipient) {
        // ... (—Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∞—è –ª–æ–≥–∏–∫–∞ joinRoom) ...
        // –ü–æ—Å–ª–µ —Å–º–µ–Ω—ã –∫–æ–º–Ω–∞—Ç—ã:
        showChatWindow(); 
        updateUnreadCount(recipient, 0); 
        socket.emit('join room', recipient);
    }
    
    // --- –ì–û–õ–û–°–û–í–´–ï –°–û–û–ë–©–ï–ù–ò–Ø (–£–°–ò–õ–ï–ù–ù–ê–Ø –õ–û–ì–ò–ö–ê) ---

    function startRecording() {
        // ... (–ª–æ–≥–∏–∫–∞ startRecording) ...
        navigator.mediaDevices.getUserMedia({ audio: true })
            .then(stream => {
                // ... (–∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è MediaRecorder) ...
                mediaRecorder.start();
                isRecording = true;
                voiceRecordBtn.classList.add('recording'); 
                voiceRecordBtn.textContent = '‚èπÔ∏è'; 
            })
            .catch(e => {
                alert(`–û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É: ${e.message}`);
            });
    }

    function stopRecording() {
        if (mediaRecorder && mediaRecorder.state !== 'inactive') {
            mediaRecorder.stop();
            isRecording = false;
            voiceRecordBtn.classList.remove('recording');
            voiceRecordBtn.textContent = 'üéôÔ∏è';
        }
    }
    
    // --- –ê–í–¢–û–ú–ê–¢–ò–ß–ï–°–ö–û–ï –†–ê–°–®–ò–†–ï–ù–ò–ï –ü–û–õ–Ø –í–í–û–î–ê ---
    messageInput.addEventListener('input', () => {
        messageInput.style.height = 'auto';
        messageInput.style.height = messageInput.scrollHeight + 'px';
    });

    // --- –û–ë–†–ê–ë–û–¢–ß–ò–ö–ò –°–û–ë–´–¢–ò–ô (–ú–ï–î–ò–ê) ---
    
    // –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –≤ fileInput.addEventListener('change', ...) –≤—ã –∏—Å–ø–æ–ª—å–∑—É–µ—Ç–µ file.type 
    // –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–≥–æ MIME-—Ç–∏–ø–∞, –∫–æ—Ç–æ—Ä—ã–π –±—É–¥–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è.

    // ... (–≤–µ—Å—å –æ—Å—Ç–∞–ª—å–Ω–æ–π JS-–∫–æ–¥) ...

    socket.on('login', (success, data) => {
        if (success) {
            // ... (—Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π –∫–æ–¥ –ª–æ–≥–∏–Ω–∞) ...
            
            // –ü–ï–†–í–´–ô –ó–ê–ü–£–°–ö –ù–ê –ú–û–ë–ò–õ–¨–ù–û–ú: –°–∫—Ä—ã—Ç—å —á–∞—Ç –∏ –ø–æ–∫–∞–∑–∞—Ç—å —Å–ø–∏—Å–æ–∫
            if (window.innerWidth <= 768) {
                userList.style.transform = 'translateX(0)';
                backToListBtn.style.display = 'none';
            }
        }
    });

</script>
</body>
</html>